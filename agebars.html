<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Age by Year Visualization</title>
		<script type="text/javascript" src="d3.min.js"></script>
		<script type="text/javascript" src="d3tip.js"></script>		

    
		<link rel="stylesheet" href="//code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css">
		<script src="//code.jquery.com/jquery-1.10.2.js"></script>
		<script src="//code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
		<script type="text/javascript" src="js/jquery.history.js"></script>	
		
		<style>
rect:hover {
  fill: rgba(100, 100, 100, 0.8);
}



.d3-tip {
  line-height: 1;
  padding: 12px;
  background: rgba(100, 100, 100, 0.8);
  color: white;
  border-radius: 5px;
  z-index: 3000;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(100, 100, 100, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
   z-index: 3000; 
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
  z-index: 3000;
}
		
		.yaxis path,
		.yaxis line {
			fill: none;
			stroke: black;
			shape-rendering: crispEdges;
		}
		
		.yaxis text {
			font-family: sans-serif;
			font-size: 11px;
		}
		

		.xaxis path,
		.xaxis line {
			fill: none;
			stroke: black;
			shape-rendering: crispEdges;
		}
		
		.xaxis text {
			font-family: sans-serif;
			font-size: 11px;
		}

		
		.grid .tick {
			stroke: lightgrey;
			opacity: 0.7;
		}
		
		.grid path {
			stroke-width: 0;
		}
		


		#mainsvg{
		position: absolute;
		top: 100px;
		left: 10px;
		outline: #000 solid 2px;
		}
		
		
		#year{
		position: absolute;
		top: 50px;
		left: 900px;
		z-index: 100;
					font-family: sans-serif;
			font-size: 40px;	
		}
		
		
		#title{
		position: absolute;
		top: 50px;
		left: 500px;
		z-index: 100;
					font-family: sans-serif;
			font-size: 40px;	
		}
		


.ui-selectmenu-button span.ui-selectmenu-text{
		font-size: 10px !important;
		}
		
.ui-menu-item {
		font-size: 10px !important;
}
		
		#aselect{
		width: 120px;
		}
		
		#ayear{
		width: 100px;

		}

		#abutton{
		font-size: 10px !important;
		}
		

		
  .overflow { height: 200px; }
  
  
  #controls {
	position: absolute;
	top: 10px;
	left: 10px;
	width: 300px;
  }
  
  #leg{
  position: absolute;
  top: 610px;
  left: 8px;
  }

		</style>
	</head>
	
			<span id="title"></span>	
		<span id="year"></span>
		
		<img id="leg" src="legend.png" />

	
		<script type="text/javascript" src="data/all.js"></script>
		<script type="text/javascript" src="data/all_supplemental.js"></script>	

		<!--<script type="text/javascript" src="data/_000.js"></script>	-->
		
	<body>


		<div id="controls">
		

				
		<select id="aselect">
			<option value="000">Colorado</option>		
			<option value="001">Adams</option>
			<option value="003">Alamosa</option>
			<option value="005">Arapahoe</option>
			<option value="007">Archuleta</option>
			<option value="009">Baca</option>
			<option value="011">Bent</option>
			<option value="013">Boulder</option>
			<option value="014">Broomfield</option>
			<option value="015">Chaffee</option>
			<option value="017">Cheyenne</option>
			<option value="019">Clear Creek</option>
			<option value="021">Conejos</option>
			<option value="023">Costilla</option>
			<option value="025">Crowley</option>
			<option value="027">Custer</option>
			<option value="029">Delta</option>
			<option value="031">Denver</option>
			<option value="033">Dolores</option>
			<option value="035">Douglas</option>
			<option value="037">Eagle</option>
			<option value="039">Elbert</option>
			<option value="041">El Paso</option>
			<option value="043">Fremont</option>
			<option value="045">Garfield</option>
			<option value="047">Gilpin</option>
			<option value="049">Grand</option>
			<option value="051">Gunnison</option>
			<option value="053">Hinsdale</option>
			<option value="055">Huerfano</option>
			<option value="057">Jackson</option>
			<option value="059">Jefferson</option>
			<option value="061">Kiowa</option>
			<option value="063">Kit Carson</option>
			<option value="065">Lake</option>
			<option value="067">La Plata</option>
			<option value="069">Larimer</option>	
			<option value="071">Las Animas</option>
			<option value="073">Lincoln</option>
			<option value="075">Logan</option>
			<option value="077">Mesa</option>
			<option value="079">Mineral</option>
			<option value="081">Moffat</option>
			<option value="083">Montezuma</option>
			<option value="085">Montrose</option>
			<option value="087">Morgan</option>
			<option value="089">Otero</option>
			<option value="091">Ouray</option>
			<option value="093">Park</option>
			<option value="095">Phillips</option>	
			<option value="097">Pitkin</option>
			<option value="099">Prowers</option>
			<option value="101">Pueblo</option>	
			<option value="103">Rio Blanco</option>	
			<option value="105">Rio Grande</option>	
			<option value="107">Routt</option>	
			<option value="109">Saguache</option>	
			<option value="111">San Juan</option>	
			<option value="113">San Miguel</option>	
			<option value="115">Sedgwick</option>	
			<option value="117">Summit</option>	
			<option value="119">Teller</option>	
			<option value="121">Washington</option>	
			<option value="123">Weld</option>	
			<option value="125">Yuma</option>				
		</select>

		<select id="ayear">
			<option value="1990">1990</option>
			<option value="1991">1991</option>
			<option value="1992">1992</option>
			<option value="1993">1993</option>
			<option value="1994">1994</option>
			<option value="1995">1995</option>
			<option value="1996">1996</option>
			<option value="1997">1997</option>
			<option value="1998">1998</option>
			<option value="1999">1999</option>
			<option value="2000">2000</option>
			<option value="2001">2001</option>
			<option value="2002">2002</option>
			<option value="2003">2003</option>
			<option value="2004">2004</option>
			<option value="2005">2005</option>
			<option value="2006">2006</option>
			<option value="2007">2007</option>
			<option value="2008">2008</option>
			<option value="2009">2009</option>
			<option value="2010">2010</option>
			<option value="2011">2011</option>
			<option value="2012">2012</option>
			<option value="2013">2013</option>
			<option value="2014">2014</option>
			<option value="2015">2015</option>
			<option value="2016">2016</option>
			<option value="2017">2017</option>
			<option value="2018">2018</option>
			<option value="2019">2019</option>
			<option value="2020">2020</option>
			<option value="2021">2021</option>
			<option value="2022">2022</option>
			<option value="2023">2023</option>
			<option value="2024">2024</option>
			<option value="2025">2025</option>	
			<option value="2026">2026</option>
			<option value="2027">2027</option>
			<option value="2028">2028</option>
			<option value="2029">2029</option>
			<option value="2030">2030</option>
			<option value="2031">2031</option>
			<option value="2032">2032</option>
			<option value="2033">2033</option>
			<option value="2034">2034</option>
			<option value="2035">2035</option>
			<option value="2036">2036</option>
			<option value="2037">2037</option>
			<option value="2038">2038</option>	
			<option value="2039">2039</option>
			<option value="2040">2040</option>
			<option value="2041">2041</option>
			<option value="2042">2042</option>
			<option value="2043">2043</option>
			<option value="2044">2044</option>
			<option value="2045">2045</option>
			<option value="2046">2046</option>
			<option value="2047">2047</option>
			<option value="2048">2048</option>	
			<option value="2049">2049</option>
			<option value="2050">2050</option>      
		</select>
		
						<button id="abutton" >Animate</button>	

		
		</div>
		
		<script type="text/javascript">

			$(function() {
			
        //for jquery history plugin
History.Adapter.bind(window,'statechange',function(){ // Note: We are using statechange instead of popstate
        var State = History.getState(); // Note: We are using History.getState() instead of event.state

  
    });
        
      function parseQueryString(){
  var newstr, objURL;
  newstr = String(window.location.search);
  objURL = {};
  newstr.replace(
    new RegExp("([^?=&]+)(=([^&]*))?", "g"), function ($0, $1, $2, $3) {
      objURL[$1] = $3;
    });
  console.log(objURL);
  return objURL;
}
      
var params = parseQueryString();
      
      //three possible parameters: county, year, and stop
      //stop indicates that there is animation, which would run from 'year' to 'stop'
	
     //aselect
        
        var presetcounty = params.county || "000";
        $('#aselect').val(presetcounty);
      
      //ayear
      var presetyear = params.year || "1990";
         $('#ayear').val(presetyear);     
        
        
	
        $('#aselect').selectmenu({
            change: function() {
                jsFunction($('#aselect').val());
            }
			}).selectmenu( "menuWidget" )
    .addClass( "overflow" );
 
        $('#ayear').selectmenu({
            change: function() {
                uyear($('#ayear').val());
            }
        }).selectmenu( "menuWidget" )
    .addClass( "overflow" );;
	
	    $( "#abutton" ).button()
      .click(function( event ) {
        event.preventDefault();
		animate();		
      });
	  
	$('#aselect').position({
	"my": "left top",
	"at": "left top",
	"of": $("#controls")
	});	  
	  
	$('#ayear').position({
	"my": "right top",
	"at": "right top",
	"of": $("#controls")
	});

	$( "#abutton" ).position({
	"my": "left top",
	"at": "right top",
	"of": $("#controls")
	});
		
		
function commafy(nStr) {
	var x, x1, x2, rgx;

	nStr += '';
	x = nStr.split('.');
	x1 = x[0];
	x2 = x.length > 1 ? '.' + x[1] : '';
	rgx = /(\d+)(\d{3})/;
	while (rgx.test(x1)) {
		x1 = x1.replace(rgx, '$1' + ',' + '$2');
	}
	return x1 + x2;
}

			//Width and height
			var w = 1000;
			var h = 500;
			var speed = 400;
			var l=0; //setinterval
			
			
			var xpadding=15;  //top and right padding
			var padding=60;  //left padding
			var spadding=30; //bottom padding



			var year = params.year || 1990;
			var county= params.county || "000";
      

			document.getElementById('title').innerHTML=changetitle(county);
			document.getElementById('year').innerHTML=year;
			
			
			var dataset = eval("_" + county + "_" + String(year));		
			
			
			var xScale = d3.scale.linear()
							.domain([0, 90])
							.range([padding, w-xpadding]);

			var yScale = d3.scale.linear()
							.domain([0, maxlookup(county)])
							.range([0, h-(spadding+xpadding)]);
							
			var yScaleAxis = d3.scale.linear()
							.domain([0, maxlookup(county)])
							.range([h-spadding, xpadding]);
			


			
			function make_x_axis() {        
				return d3.svg.axis()
						.scale(xScale)
						.orient("bottom")
						.ticks(11)
			}

			function make_y_axis() {        
				return d3.svg.axis()
						.scale(yScaleAxis)
						.orient("left")
						.ticks(10)
			}
			
			
			var xAxis=d3.svg.axis()
						.scale(xScale)
						.orient("bottom")
						.ticks(11);
						
			var yAxis=d3.svg.axis()
						.scale(yScaleAxis)
						.orient("left")
						.ticks(10);
			
var tip = d3.tip()
  .attr('class', 'd3-tip')
  .offset([-10, 0])
  .html(function(d) {
    return "Age: <span style='color:white'>" + (Number(year) - Number(d.k)) + "</span><br />Birth Year: <span style='color:white'>" + (Number(d.k)) + "</span><br />Population: <span style='color:white'>" + commafy(d.v) + "</span>";
  })
			
			//Create SVG element
			var svg = d3.select("body")
						.append("svg")
						.attr("width", w)
						.attr("height", h)
						.attr("id", "mainsvg");		

			
svg.call(tip);			
			
			svg.append("g")
				.attr("class", "xaxis")
				.attr("transform", "translate(0," + (h-spadding) + ")")
				.call(xAxis);

			svg.append("g")
				.attr("class", "yaxis")
				.attr("transform", "translate(" + (padding-5) + ", -2)")
				.call(yAxis);
				
			svg.append("g")         
				.attr("class", "grid")
				.attr("id", "xgrid")
				.attr("transform", "translate(0," + (h - spadding) + ")")
				.call(make_x_axis()
					.tickSize(-h, 0, 0)
					.tickFormat("")
				);

			svg.append("g")         
				.attr("class", "grid")
				.attr("id", "ygrid")
				.attr("transform", "translate(" + (padding-5) + ", " + (-2) + ")")
				.call(make_y_axis()
					.tickSize(-w, 0, 0)
					.tickFormat("")
				);

				
				//Define key function, to be used when binding data
			var k = function(d) {
				return d.k;
			};			
				
			//Create bars
			svg.selectAll("rect")
			   .data(dataset, k)
			   .enter()
			   .append("rect")
						.attr("x", function(d) {
							return (padding - 4 + ((year - d.k)*10.265));				
						})		
						.attr("y", function(d) {
							return (h - yScale(d.v))-spadding - 2;
						})
						.attr("width", 7.5)
						.attr("height", function(d) {
							return yScale(d.v);
						})
				.attr("fill", function(d) {
					var cyear = (d.k);
					if(cyear<1928){creturn="rgba(247, 150, 70, 0.9)";}
					if(cyear>1927 && cyear<1946){creturn="rgba(75, 172, 198, 0.9)";}
					if(cyear>1945 && cyear<1965){creturn="rgba(128, 100, 162, 0.9)";}
					if(cyear>1964 && cyear<1980){creturn="rgba(155, 187, 89, 0.9)";}
					if(cyear>1979 && cyear<2000){creturn="rgba(192, 80, 77, 0.9)";}
					if(cyear>1999){creturn="rgba(79, 129, 189, 0.9)";}							
					return creturn;
				})
      .on('mouseover', tip.show)
      .on('mouseout', tip.hide);


//automatically kicks into animation mode if stop parameter is set
if(parseInt(params.stop,10)>0){setTimeout(function(){animate();}, 1000); }

				function update(){

				dataset=eval("_" + county + "_"+String(year));		
				
					//Select…
					var bars = svg.selectAll("rect")
						.data(dataset, k);

					
					bars.enter().append("rect")
					.attr("x", function(d) {
							return (padding - 4 + ((year - d.k)*10.265));						
						})						
						.attr("y", function(d) {
							return (h - yScale(d.v))-spadding - 2;
						})
						.attr("width", 7.5)
						.attr("height", function(d) {
							return yScale(d.v);
						})
						.attr("fill", function(d) {
							var cyear = (d.k);
							if(cyear<1928){creturn="rgba(247, 150, 70, 0.9)";}
							if(cyear>1927 && cyear<1946){creturn="rgba(75, 172, 198, 0.9)";}
							if(cyear>1945 && cyear<1965){creturn="rgba(128, 100, 162, 0.9)";}
							if(cyear>1964 && cyear<1980){creturn="rgba(155, 187, 89, 0.9)";}
							if(cyear>1979 && cyear<2000){creturn="rgba(192, 80, 77, 0.9)";}
							if(cyear>1999){creturn="rgba(79, 129, 189, 0.9)";}							
							return creturn;
						})      
						.on('mouseover', tip.show)
						.on('mouseout', tip.hide);

					//Update…
					bars.transition()
						.duration(speed)
						.ease("linear")
						.attr("x", function(d) {
							return (padding - 4 + ((year - d.k)*10.265));						
						})						
						.attr("y", function(d) {
							return (h - yScale(d.v))-spadding - 2;
						})
						.attr("width", 7.5)
						.attr("height", function(d) {
							return yScale(d.v);
						})
						.attr("fill", function(d) {
							var cyear = (d.k);
							if(cyear<1928){creturn="rgba(247, 150, 70, 0.9)";}
							if(cyear>1927 && cyear<1946){creturn="rgba(75, 172, 198, 0.9)";}
							if(cyear>1945 && cyear<1965){creturn="rgba(128, 100, 162, 0.9)";}
							if(cyear>1964 && cyear<1980){creturn="rgba(155, 187, 89, 0.9)";}
							if(cyear>1979 && cyear<2000){creturn="rgba(192, 80, 77, 0.9)";}
							if(cyear>1999){creturn="rgba(79, 129, 189, 0.9)";}							
							return creturn;
						});


					bars.exit().remove();		
						
				}

				
		function animate(){
		var stopyear = parseInt(params.stop,10) || 2050;
      

		if(l==0){l = window.setInterval(updatefunc, speed);}else{
      
      //if animate button pressed, but animation active.  stop animation.  set dropdown year to correct year.  update url string.
      
      clearInterval(l);l=0;
      
         $('#ayear').val(year);  
        $("#ayear").selectmenu("refresh");
        
          //create a URL string with all variables not at a default value
    urlstr='?'+'county='+$('#aselect').val() +'&year='+year;
    newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + urlstr;

		History.pushState({path:newurl},'',newurl);
    
    }

			function updatefunc(){
				
			year++;
					
			if(year>stopyear){
        clearInterval(l);
        year=stopyear;
        l=0;
        var presetyear = params.stop || "2050";
        presetyear=presetyear.toString();
         $('#ayear').val(presetyear);  
        $("#ayear").selectmenu("refresh");
        
          //create a URL string with all variables not at a default value
    urlstr='?'+'county='+$('#aselect').val() +'&year='+$('#ayear').val();
    newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + urlstr;

		History.pushState({path:newurl},'',newurl);
        
      }else{
				document.getElementById('year').innerHTML=year;
				update();
				}
			}
			
			

		}		



		function jsFunction(pvalue){


  
  //create a URL string with all variables not at a default value
    urlstr='?'+'county='+pvalue +'&year='+year;
    newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + urlstr;

		History.pushState({path:newurl},'',newurl);
		
		clearInterval(l);
		l=0;
		
		county = pvalue;

		dataset = eval("_" + county + "_" + String(year));			
		
		
		datasetmax=eval("_" + county + "_2050");	
		
		yScale.domain([0, maxlookup(county)]);

		yScaleAxis.domain([0, maxlookup(county)]);
		
		
		
           svg.select(".yaxis")
		   .transition().duration(300).ease("linear")
		   .call(yAxis); 	
					
           svg.select("#ygrid")
		   .transition().duration(300).ease("linear")
		   .call(make_y_axis()
					.tickSize(-w, 0, 0)
					.tickFormat("")
				); 	
		   
		document.getElementById('title').innerHTML=changetitle(county);

		
		update();
		
		}

		
		function maxlookup(county){
			var years=[];
			for(i=0; i<61; i++){ years[i]= d3.max(eval("_" + county + "_" + String(1990 + i)), function(d) { return d.v; }) }
			return Math.max.apply(Math, years);
		}			
		
		
				
			
		function changetitle(pvalue){
			if(pvalue=="000"){return "Colorado";}
			if(pvalue=="001"){return "Adams County";}
			if(pvalue=="003"){return "Alamosa County";}
			if(pvalue=="005"){return "Arapahoe County";}
			if(pvalue=="007"){return "Archuleta County";}
			if(pvalue=="009"){return "Baca County County";}
			if(pvalue=="011"){return "Bent County County";}
			if(pvalue=="013"){return "Boulder County";}
			if(pvalue=="014"){return "Broomfield County";}
			if(pvalue=="015"){return "Chaffee County";}
			if(pvalue=="017"){return "Cheyenne County";}
			if(pvalue=="019"){return "Clear Creek County";}
			if(pvalue=="021"){return "Conejos County";}
			if(pvalue=="023"){return "Costilla County";}
			if(pvalue=="025"){return "Crowley County";}
			if(pvalue=="027"){return "Custer County";}
			if(pvalue=="029"){return "Delta County";}
			if(pvalue=="031"){return "Denver County";}
			if(pvalue=="033"){return "Dolores County";}
			if(pvalue=="035"){return "Douglas County";}
			if(pvalue=="037"){return "Eagle County";}
			if(pvalue=="039"){return "Elbert County";}
			if(pvalue=="041"){return "El Paso County";}
			if(pvalue=="043"){return "Fremont County";}
			if(pvalue=="045"){return "Garfield County";}
			if(pvalue=="047"){return "Gilpin County";}
			if(pvalue=="049"){return "Grand County";}
			if(pvalue=="051"){return "Gunnison County";}
			if(pvalue=="053"){return "Hinsdale County";}
			if(pvalue=="055"){return "Huerfano County";}
			if(pvalue=="057"){return "Jackson County";}
			if(pvalue=="059"){return "Jefferson County";}
			if(pvalue=="061"){return "Kiowa County";}
			if(pvalue=="063"){return "Kit Carson County";}
			if(pvalue=="065"){return "Lake County";}
			if(pvalue=="067"){return "La Plata County";}
			if(pvalue=="069"){return "Larimer County";}	
			if(pvalue=="071"){return "Las Animas County";}
			if(pvalue=="073"){return "Lincoln County";}
			if(pvalue=="075"){return "Logan County";}
			if(pvalue=="077"){return "Mesa County";}
			if(pvalue=="079"){return "Mineral County";}
			if(pvalue=="081"){return "Moffat County";}
			if(pvalue=="083"){return "Montezuma County";}
			if(pvalue=="085"){return "Montrose County";}
			if(pvalue=="087"){return "Morgan County";}
			if(pvalue=="089"){return "Otero County";}
			if(pvalue=="091"){return "Ouray County";}
			if(pvalue=="093"){return "Park County";}
			if(pvalue=="095"){return "Phillips County";}	
			if(pvalue=="097"){return "Pitkin County";}
			if(pvalue=="099"){return "Prowers County";}
			if(pvalue=="101"){return "Pueblo County";}	
			if(pvalue=="103"){return "Rio Blanco County";}	
			if(pvalue=="105"){return "Rio Grande County";}	
			if(pvalue=="107"){return "Routt County";}	
			if(pvalue=="109"){return "Saguache County";}	
			if(pvalue=="111"){return "San Juan County";}	
			if(pvalue=="113"){return "San Miguel County";}	
			if(pvalue=="115"){return "Sedgwick County";}	
			if(pvalue=="117"){return "Summit County";}	
			if(pvalue=="119"){return "Teller County";}	
			if(pvalue=="121"){return "Washington County";}	
			if(pvalue=="123"){return "Weld County";}	
			if(pvalue=="125"){return "Yuma County";}		

		}				
		
		function uyear(newyear){
		
      //create a URL string with all variables not at a default value
    urlstr='?'+'county='+$('#aselect').val() +'&year='+newyear;
    newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + urlstr;

		History.pushState({path:newurl},'',newurl);  
      
		clearInterval(l);
		l=0;
		year=newyear;
		

		document.getElementById('year').innerHTML=year;

		
		update();
		}
		
      
      });
		</script>

	</body>

</html>